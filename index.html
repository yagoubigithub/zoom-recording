<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broadcast live microphone over LAN</title>

    <style>
        body{
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }
    </style>
</head>

<body>




    <div >
        <input type="text" placeholder="Name" id="name">
        <button id="join-btn">Join</button>
    </div>
    <script type="module">
        import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";

        const url = 'http://localhost:3000';
        //  const url = 'https://zoom-recording-0uiz.onrender.com/';

        getUers();


        document.getElementById("join-btn").addEventListener("click", () => {

            const name = document.getElementById("name").value;
            alert(name);
        
           
            
            let socket = io(url, {
                transports: ['websocket'],
                upgrade: false
            });

            socket.on('connect', () => {
                navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                    .then((stream) => {
                        socket.emit("new-user", name);
                        var madiaRecorder = new MediaRecorder(stream);
                        var audioChunks = [];

                        madiaRecorder.addEventListener("dataavailable", function (event) {
                            audioChunks.push(event.data);
                        });

                        madiaRecorder.addEventListener("stop", function () {
                            var audioBlob = new Blob(audioChunks);
                            audioChunks = [];
                            var fileReader = new FileReader();
                            fileReader.readAsDataURL(audioBlob);
                            fileReader.onloadend = function () {
                                var base64String = fileReader.result;
                                socket.emit("audioStream", base64String);
                            };

                            madiaRecorder.start();
                            setTimeout(function () {
                                madiaRecorder.stop();
                            }, 1000);
                        });

                        madiaRecorder.start();
                        setTimeout(function () {
                            madiaRecorder.stop();
                        }, 1000);
                    })
                    .catch((error) => {
                        console.error('Error capturing audio.', error);
                    });
            });

            socket.on('audioStream', (audioData) => {
                var newData = audioData.split(";");
                newData[0] = "data:audio/ogg;";
                newData = newData[0] + newData[1];

                var audio = new Audio(newData);
                if (!audio || document.hidden) {
                    return;
                }
                audio.play();
            });

        })
   
   


        function getUers() {
            fetch(`${url}/users`).then((res)=>res.json()).then(data=>{
                
                console.log(data)
        
            })
        }

   </script>


</body>

</html>