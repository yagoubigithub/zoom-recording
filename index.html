<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Broadcast live microphone over LAN</title>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, Helvetica, sans-serif;
        }
        .container{
            display: flex;
            flex-direction: column;
            height: 100vh;
            width: 100vw;


        }
        .content{
            flex : 9;
        }
        .input-container {
            flex : 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .input-container input {
            padding:12px;
            width : 80%;

        }
        .input-container button{
            width: 10%;
            padding: 12px;
            background-color: blueviolet;
            color: white;
        }
        .content ul {
            padding: 0;
            list-style: none;

        }


        .content ul  li{
            padding: 12px;
            font-size: 20px;
            background-color: #f2f2f2;
            margin: 8px;


        }
    </style>
</head>

<body>




    <div class="container">


        <div class="content">
            <h1>Pepole in the room</h1>
            <ul id="users-list">

            </ul>
        </div>

        <div class="input-container" >
            <input type="text" placeholder="Name" id="name">
            <button id="join-btn">Join</button>
        </div>

    </div>
    <script type="module">
        import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";

        //const url = 'http://localhost:3000';
        const url = 'https://zoom-recording-0uiz.onrender.com/';

        getUers();


        document.getElementById("join-btn").addEventListener("click", () => {

            const name = document.getElementById("name").value;
            document.getElementById("name").value = '';



            let socket = io(url, {
                transports: ['websocket'],
                upgrade: false
            });

            socket.on('connect', () => {
                
                navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                    .then((stream) => {
                        socket.emit("new-user", name);
                        getUers();
                       const inputContainer =  document.getElementsByClassName("input-container");
                        var madiaRecorder = new MediaRecorder(stream);
                        var audioChunks = [];

                        madiaRecorder.addEventListener("dataavailable", function (event) {
                            audioChunks.push(event.data);
                        });

                        madiaRecorder.addEventListener("stop", function () {
                            var audioBlob = new Blob(audioChunks);
                            audioChunks = [];
                            var fileReader = new FileReader();
                            fileReader.readAsDataURL(audioBlob);
                            fileReader.onloadend = function () {
                                var base64String = fileReader.result;
                                socket.emit("audioStream", base64String);
                            };

                            madiaRecorder.start();
                            setTimeout(function () {
                                madiaRecorder.stop();
                            }, 1000);
                        });

                        madiaRecorder.start();
                        setTimeout(function () {
                            madiaRecorder.stop();
                        }, 1000);
                    })
                    .catch((error) => {
                        console.error('Error capturing audio.', error);
                    });
            });

            socket.on('user-disconnected', (audioData) => {

                getUers();

            })
            socket.on('user-connected', (audioData) => {


                getUers();

            })
            socket.on('audioStream', (audioData) => {
                var newData = audioData.split(";");
                newData[0] = "data:audio/ogg;";
                newData = newData[0] + newData[1];

                var audio = new Audio(newData);
                if (!audio || document.hidden) {
                    return;
                }
                audio.play();
            });

        })




        function getUers() {
            fetch(`${url}/users`).then((res) => res.json()).then(data => {

                Object.keys(data).map(id => {
                    const li = document.createElement("li")
                    li.innerHTML = data[id];

                    const usersList = document.getElementById("users-list")
                    usersList.append(li)


                })

            })
        }

    </script>


</body>

</html>